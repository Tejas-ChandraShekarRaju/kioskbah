{% extends "base.html" %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #008080;
        --secondary-color: #006666;
        --accent-color: #00b3b3;
        --text-color: #333;
        --light-bg: #f8f9fa;
    }

    .section-header {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }

    .section-icon {
        width: 80px;
        height: 80px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .section-icon i {
        font-size: 2.5rem;
        color: white;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    /* Table styles */
    .table {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .table thead {
        background-color: var(--light-bg);
    }

    .table thead th {
        color: var(--text-color);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        border: none;
        padding: 1rem;
    }

    .table tbody tr {
        border-bottom: 1px solid #e0f2f1;
    }

    .table tbody tr:hover {
        background-color: #f5f9f9;
    }

    .table td {
        padding: 1rem;
        color: #2c3e50;
        vertical-align: middle;
    }

    .media-badge {
        background: var(--light-bg);
        color: var(--text-color);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        margin-right: 0.5rem;
    }

    .btn-teal {
        background-color: var(--primary-color);
        color: white;
        border: none;
    }

    .btn-teal:hover {
        background-color: var(--secondary-color);
        color: white;
    }

    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(0, 128, 128, 0.25);
    }

    .btn-info {
        background-color: var(--accent-color);
        color: white;
        border: none;
    }

    .btn-info:hover {
        background-color: var(--secondary-color);
        color: white;
    }

    /* Modal styles */
    .modal-content {
        background-color: #2a2a2a;
        color: #fff;
    }

    .modal-header {
        border-bottom: 1px solid #444;
    }

    .modal-footer {
        border-top: 1px solid #444;
    }

    .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    .modal .form-control {
        background-color: #333;
        border: 1px solid #444;
        color: #fff;
    }

    .modal .form-control:focus {
        background-color: #333;
        border-color: var(--primary-color);
        color: #fff;
        box-shadow: none;
    }

    .modal .form-label {
        color: #fff;
    }

    .btn-secondary {
        background-color: #444;
        border: none;
    }

    .btn-secondary:hover {
        background-color: #555;
    }

    .modal .btn-primary {
        background-color: var(--primary-color);
        border: none;
    }

    .modal .btn-primary:hover {
        background-color: var(--secondary-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Section Header -->
    <div class="section-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <div class="section-icon">
                    <i class="fas {{ section.icon }}"></i>
                </div>
                <div>
                    <h1 class="mb-1">{{ section.name }}</h1>
                    <p class="mb-0">{{ section.description }}</p>
                </div>
            </div>
            <a href="{{ url_for('sections.manage_sections') }}" class="btn btn-outline-light">
                <i class="fas fa-arrow-left"></i> Back to Sections
            </a>
        </div>
    </div>

    <!-- Subsections Table -->
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="card-title mb-0">Manage Subsections</h5>
                <button class="btn btn-teal" id="addSubsectionBtn">
                    <i class="fas fa-plus"></i> Add Subsection
                </button>
            </div>

            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Subsection Name</th>
                            <th>Description</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for subsection in subsections %}
                        <tr>
                            <td class="fw-medium">
                                {{ subsection.name }}
                            </td>
                            <td>
                                <div class="text-wrap" style="max-width: 500px;">
                                    {{ subsection.description }}
                                </div>
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-info upload-media" data-id="{{ subsection.id }}">
                                    <i class="fas fa-upload"></i> Upload Media
                                </button>
                                <button class="btn btn-sm btn-info edit-subsection me-2" data-id="{{ subsection.id }}"
                                    data-name="{{ subsection.name }}" data-description="{{ subsection.description }}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <a href="{{ url_for('sections.manage_media', subsection_id=subsection.id) }}"
                                    class="btn btn-sm btn-teal me-2">
                                    <i class="fas fa-photo-video"></i> Manage Media
                                </a>
                                <button class="btn btn-sm btn-danger delete-subsection" data-id="{{ subsection.id }}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="3" class="text-center py-4">
                                <div class="alert alert-info mb-0">
                                    No subsections found. Add your first subsection using the form above.
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const createUploadMediaModal = (subsectionId) => {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.setAttribute('id', 'uploadMediaModal');
        modal.setAttribute('tabindex', '-1');
        modal.setAttribute('aria-hidden', 'true');
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Upload New Media</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="uploadMediaForm" enctype="multipart/form-data">
                            <input type="hidden" name="subsection_id" value="${subsectionId}">
                            <div class="mb-3">
                                <label for="title" class="form-label">Title</label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="file" class="form-label">Select Files</label>
                                <input type="file" class="form-control" id="file" name="file" multiple required>
                            </div>
                            
                            <div id="selectedFiles" class="mt-3">
                                <!-- Selected files will be displayed here -->
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancelUploadMedia">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveNewMedia">Upload</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        return modal;
    };

    // Handle Upload Media button click
    const uploadMediaBtns = document.querySelectorAll('.upload-media');
    let uploadMediaModal = null;

    uploadMediaBtns.forEach(uploadMediaBtn => {
        uploadMediaBtn.addEventListener('click', function () {
            if (uploadMediaModal) {
                uploadMediaModal.remove();
            }
            uploadMediaModal = createUploadMediaModal(this.dataset.id);
            const modalInstance = new bootstrap.Modal(uploadMediaModal);
            modalInstance.show();

            // Set up file preview in modal
            const fileInput = document.getElementById('file');
            const selectedFiles = document.getElementById('selectedFiles');

            fileInput.addEventListener('change', function () {
                selectedFiles.innerHTML = '';
                const files = Array.from(this.files);
                
                if (files.length === 0) return;

                const fileList = document.createElement('ul');
                fileList.className = 'list-group';
                
                files.forEach(file => {
                    const item = document.createElement('li');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center bg-dark text-white border-secondary';
                    
                    let icon = 'file';
                    if (file.type.startsWith('image/')) icon = 'image';
                    else if (file.type.startsWith('video/')) icon = 'video';
                    else if (file.type === 'application/pdf') icon = 'file-pdf';
                    
                    item.innerHTML = `
                        <div>
                            <i class="fas fa-${icon} me-2"></i>
                            ${file.name}
                        </div>
                        <span class="badge bg-secondary">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                    `;
                    fileList.appendChild(item);
                });
                
                selectedFiles.appendChild(fileList);
            });

            // Handle save
            document.getElementById('saveNewMedia').addEventListener('click', function () {
                const form = document.getElementById('uploadMediaForm');
                const formData = new FormData();
                
                // Get the base title that will be used for all files
                const baseTitle = form.querySelector('[name="title"]').value;
                
                // Add basic form fields
                formData.append('subsection_id', form.querySelector('[name="subsection_id"]').value);
                formData.append('title', baseTitle); // Use the entered title directly
                formData.append('description', form.querySelector('[name="description"]').value);
                
                // Add all selected files
                const files = form.querySelector('[name="file"]').files;
                for (let i = 0; i < files.length; i++) {
                    formData.append('files[]', files[i]);
                }

                // Show loading state
                const saveButton = this;
                const originalText = saveButton.innerHTML;
                saveButton.disabled = true;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

                fetch('/api/media/batch', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(data => {
                                throw new Error(data.error || 'Failed to upload media');
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Create and show success alert
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-success alert-dismissible fade show';
                        alertDiv.setAttribute('role', 'alert');
                        alertDiv.innerHTML = `
                            <strong>Success!</strong> ${data.message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        `;
                        
                        // Insert alert at the top of the card body
                        const cardBody = document.querySelector('.card-body');
                        cardBody.insertBefore(alertDiv, cardBody.firstChild);
                        
                        // Auto dismiss after 5 seconds
                        setTimeout(() => {
                            const bsAlert = new bootstrap.Alert(alertDiv);
                            bsAlert.close();
                        }, 5000);
                        
                        // Close modal
                        modalInstance.hide();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert(error.message || 'An error occurred while uploading the media');
                    })
                    .finally(() => {
                        // Restore button state
                        saveButton.disabled = false;
                        saveButton.innerHTML = originalText;
                    });
            });

            // Handle cancel button
            document.getElementById('cancelUploadMedia').addEventListener('click', function () {
                modalInstance.hide();
                uploadMediaModal.remove();
                uploadMediaModal = null;
            });

            // Handle close button (X)
            const closeBtn = uploadMediaModal.querySelector('.btn-close');
            closeBtn.addEventListener('click', function () {
                modalInstance.hide();
                uploadMediaModal.remove();
                uploadMediaModal = null;
            });

            // Handle modal hidden event
            uploadMediaModal.addEventListener('hidden.bs.modal', function () {
                uploadMediaModal.remove();
                uploadMediaModal = null;
            });
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        // Create Add Subsection Modal
        const createAddSubsectionModal = () => {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.setAttribute('id', 'addSubsectionModal');
            modal.setAttribute('tabindex', '-1');
            modal.setAttribute('aria-hidden', 'true');
            modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Subsection</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addSubsectionForm">
                            <input type="hidden" name="section_id" value="{{ section.id }}">
                            <div class="mb-3">
                                <label for="name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancelAddSubsection">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveNewSubsection">Add Subsection</button>
                    </div>
                </div>
            </div>
        `;
            document.body.appendChild(modal);
            return modal;
        };

        // Handle Add Subsection button click
        const addSubsectionBtn = document.getElementById('addSubsectionBtn');
        let addSubsectionModal = null;

        addSubsectionBtn.addEventListener('click', function () {
            if (addSubsectionModal) {
                addSubsectionModal.remove();
            }
            addSubsectionModal = createAddSubsectionModal();
            const modalInstance = new bootstrap.Modal(addSubsectionModal);
            modalInstance.show();

            // Handle save
            document.getElementById('saveNewSubsection').addEventListener('click', function () {
                const form = document.getElementById('addSubsectionForm');
                const formData = new FormData(form);

                fetch('/api/subsections', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (response.ok) {
                            modalInstance.hide();
                            window.location.reload();
                        } else {
                            return response.json().then(data => {
                                throw new Error(data.error || 'Failed to add subsection');
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert(error.message || 'An error occurred while adding the subsection');
                    });
            });

            // Handle cancel button
            document.getElementById('cancelAddSubsection').addEventListener('click', function () {
                modalInstance.hide();
                addSubsectionModal.remove();
                addSubsectionModal = null;
            });

            // Handle close button (X)
            const closeBtn = addSubsectionModal.querySelector('.btn-close');
            closeBtn.addEventListener('click', function () {
                modalInstance.hide();
                addSubsectionModal.remove();
                addSubsectionModal = null;
            });

            // Handle modal hidden event
            addSubsectionModal.addEventListener('hidden.bs.modal', function () {
                addSubsectionModal.remove();
                addSubsectionModal = null;
            });
        });

        // Handle edit button clicks
        document.querySelectorAll('.edit-subsection').forEach(button => {
            button.addEventListener('click', function () {
                const subsectionId = this.dataset.id;
                const subsectionName = this.dataset.name;
                const subsectionDescription = this.dataset.description;

                // Create and show modal
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.setAttribute('id', 'editModal');
                modal.setAttribute('tabindex', '-1');
                modal.setAttribute('aria-hidden', 'true');
                modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Subsection</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editSubsectionForm">
                                <input type="hidden" name="section_id" value="{{ section.id }}">
                                <input type="hidden" name="subsection_id" value="${subsectionId}">
                                <div class="mb-3">
                                    <label for="edit_name" class="form-label">Name</label>
                                    <input type="text" class="form-control" id="edit_name" name="name" value="${subsectionName}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_description" class="form-label">Description</label>
                                    <textarea class="form-control" id="edit_description" name="description" rows="3">${subsectionDescription}</textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="cancelEditSubsection">Cancel</button>
                            <button type="button" class="btn btn-primary" id="saveEdit">Save Changes</button>
                        </div>
                    </div>
                </div>
            `;
                document.body.appendChild(modal);
                const modalInstance = new bootstrap.Modal(modal);
                modalInstance.show();

                // Handle save changes
                document.getElementById('saveEdit').addEventListener('click', async function () {
                    const editForm = document.getElementById('editSubsectionForm');
                    const formData = new FormData(editForm);

                    // Convert FormData to JSON object
                    const jsonData = {
                        name: formData.get('name'),
                        description: formData.get('description'),
                        section_id: formData.get('section_id')
                    };

                    try {
                        const response = await fetch(`/api/subsections/${subsectionId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(jsonData)
                        });

                        if (response.ok) {
                            modalInstance.hide();
                            window.location.reload();
                        } else {
                            const data = await response.json();
                            alert(data.error || 'Failed to update subsection');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('An error occurred while updating the subsection');
                    }
                });

                // Handle cancel button
                document.getElementById('cancelEditSubsection').addEventListener('click', function () {
                    modalInstance.hide();
                    modal.remove();
                });

                // Handle close button (X)
                const closeBtn = modal.querySelector('.btn-close');
                closeBtn.addEventListener('click', function () {
                    modalInstance.hide();
                    modal.remove();
                });

                // Clean up modal when hidden
                modal.addEventListener('hidden.bs.modal', function () {
                    modal.remove();
                });
            });
        });

        // Handle subsection deletion
        document.querySelectorAll('.delete-subsection').forEach(button => {
            button.addEventListener('click', async function () {
                if (!confirm('Are you sure you want to delete this subsection? This will also delete all associated media.')) {
                    return;
                }

                const subsectionId = this.dataset.id;

                try {
                    const response = await fetch(`/api/subsections/${subsectionId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        window.location.reload();
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Failed to delete subsection');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the subsection');
                }
            });
        });
    });
</script>
{% endblock %}